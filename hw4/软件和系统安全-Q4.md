### 1.试验任务

4、通过调试器监控计算器程序的运行，每当运行结果为666时，就改为999。

提示：找到运行结果在内存中保存的地址。监控 “=” 按键消息等。

- 抓住修改时间，现实时立即改，不能直接在程序中搜索修改“666”，不能直接通过修改数据，而是通过修改代码，textout函数调用，在textout函数的参数看看是不是“666”，将之改为“999”，即`通过windgb监控输出结果，当其为666时改为999`修改textout函数·的指针->函数在哪里（api调用与导入导出密切相关-》动态链接库->定位函数地址->下断点->检查该函数是否被调用->在被调用的时候篡改参数（ Windebug）【1.修改导入表更容易，IAT，导出表只在程序初始化的时候用一次，当程序已经初始化以后，导入表已经初始化，2.改代码，jump 地址计算清楚】） 

- 步骤：

  - 程序调用API:1.直接调用 导入表，2.GetProcAddress来调用函数，该函数获得要调用的函数的指针。 （主要搞清楚要分析的程序是32位的还是64位的）

  - 分析32位程序，看看导入表，用记事本打开，搜索关键字，产看是否调用了SetWindowTextW（调用TextOut）

  - Windbg分析，下断点，bp SetWindowTextW(断点的基础知识，通过int 3指令终端当前程序的运行，进入调试器运行处理中断；符号Symbol表，pdb（program database在变编译的时候产生，只有拥有该文件，才可以通过VS下断点实现程序的调试，可以通过pdp文件中定位API以及其函数地址）)以C:\Windows\SysWOW64

  - 搜索sybol server Windbg配置symbols`.sympath `

    `cache*c:\mysymbol;srv*http://msdl.microsoft.com/download/symbols`

    `cache*;srv*http://msdl.mcrosoft.com/download/symbols`

  - 输入人「.reload /f /i」下载相应的mysymbols，到相应的文件路径寻找

  - 为所有TextOut（ SetWindowTextW）下断点，`bp SetWindowTextW`，获得其参数在内存中的地址。（在x86模式下，所有函数的调用传参都在堆栈之中）去栈里找，call指令之前，栈顶exp+4，最左边的参数，exp+8从左往右数第二个参数

  - TEXTOUT MSDN

  - 「bl breakpointlist」查看 已经下的断点的地址，「go」恢复函数执行

  - 命中之后，查看函数参数（同样想查看函数原型 bing搜索 MSDN）

  - 「dd esp」

  - 「du poi(esp+0x8)」（bing搜索Windbg 指针）

  - 「bc SetWindowTextW」 取消已经下的断点

  - 「bp SetWindowTextW “du poi(esp+0x8) ;eu poi(esp+8) \"9\" ;g”

  - 修改截获的数据：有条件修改与无条件修改（windbg conditional breakpoint 判断函数句柄）

### 2.实验环境

- Win 7 x64
- calc.exe x64

### 3.实验过程

- 分析32位程序，看看导入表，用记事本打开，搜索关键字，产看是否调用了TextOut，或者通过SetWindowTextW等函数调用了TextOut

- 打开Windbg，file->open excutable打开calc.exe，`通过windgb监控输出结果，当被下断点用于显示的函数其值为666时改为999`

  ```bash
  BOOLSetWindowText(
  HWNDhwnd,
  LPCTSTRlpString 
  );
  ```

- 在调用函数Textout处或者调用了TextOut的函数如SetWindowTextW处设置条件断点

  ```bash
  bp SetWindowTextW
  ```

- 查看函数SetWindowTextW用于显示在计算器的结果的数据在poi(esp+0x20)处,设置条件断点，如果poi(esp+0x20)存储的字符串和666（0x3600360036）相同就将poi(esp+0x20)处存储的字符串改为999 否则不进行修改，中断程序继续运行

  ```bash
  bp SetWindowTextW ".if ((poi(poi(esp+0x20))) == 0x3600360036 ) {ezu poi(esp+0x20) \"999\";g} .else {g}"
  ```

### 4.实验结果

![image-20190320103345443](/SoftandSyssafehm/hw4/images/Que4-Result.gif)

### 5.实验问题

- [ ] 为什么把calc.exeattach到Windbg后，calc界面的按钮无法操作？
  - [x] 通过file->open excutable打开calc.exe

- [ ] 为什么通过file->open excutable打开calc.exe，没有办法在Win7的窗体中找到被打开运行的calc.exe？

  - [x] 下载windbg有问题，多次下载后调试环境解决

- [ ] 初始通过直接在Windbg中运行命令以实现试验任务，但是不能实现条件修改，无论在计算器上输入什么内容都会被修改为`999`输出

  ```bash
  #在calc.exe运行过程中为SetWindowTextW函数下断点(该函数调用了TextOut函数)，
  #du poi(esp+0x8) 以unicode编码形式显示在断点处指针位置esp+8，即指向WindowTextW的第二个参数（用于显示的字符串）的指针的内容
  #eu poi(esp+8) 后把该指针(esp+8)所指位置的字符串数据数据修改为目标数据，
  #du poi(esp+0x8) 以unicode编码形式显示指针esp+8指向的被修改后的内容
  #g 恢复函数运行
  bp SetWindowTextW “du poi(esp+0x20) ;eu poi(esp+0x8) \"999\" ;du poi(esp+0x20) ;g”
  ```

  ![image-20190320103345443](/SoftandSyssafehm/hw4/images/image-20190320103345443.png)

  - [x] 通过将命令编写在运行脚本脚本之中，实现只有在poi(exp+0x20)即传入 SetWindowTextW的用于输出的参数为`666`时修改为`999`，实验结果已经通过录屏显示。

  